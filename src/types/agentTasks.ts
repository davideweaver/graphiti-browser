export interface ScheduledTask {
  id: string;
  name: string;
  description?: string;
  schedule?: string; // Cron expression
  runAt?: string; // ISO datetime for one-time tasks
  task: string; // Module name (e.g., "run-agent")
  enabled: boolean;
  properties: Record<string, unknown>;
  createdAt: string;
  updatedAt: string;
}

export interface NormalizedTaskResult {
  /** Display layer - REQUIRED for UI rendering */
  display: {
    /** One-line summary for list views */
    summary: string;
    /** Full text/markdown for detail views */
    details?: string;
  };
  /** Metrics layer - OPTIONAL, only populated when applicable */
  metrics?: {
    /** AI cost in USD (run-agent only) */
    cost?: number;
    /** Execution time in ms (all tasks) */
    duration?: number;
    /** Items processed (task-dependent) */
    items?: number;
    /** Tokens used (AI tasks only) */
    tokens?: number;
  };
  /** Metadata layer - OPTIONAL, task-specific debugging info */
  metadata?: {
    /** AI session ID (run-agent only) */
    sessionId?: string;
    /** Tool invocations (AI tasks only) */
    toolCalls?: number;
    /** Task categorization */
    taskType?: string;
  };
}

export interface TaskExecution {
  /** Unique execution ID */
  id: string;
  timestamp: string;
  success: boolean;
  durationMs: number;
  error?: string;
  message?: string;
  data?: Record<string, unknown>;
  /** Normalized result in standard format for frontend consumption */
  normalizedResult?: NormalizedTaskResult;
  /** Model name used for execution (e.g., "claude-sonnet-4-5", "GLM-4.7-Flash-Q4_K_M") */
  model?: string;
  /** Whether a local model was used */
  isLocal?: boolean;
}

export interface ScheduledTaskListResponse {
  tasks: ScheduledTask[];
  count: number;
}

/**
 * Properties for run-agent tasks
 * Based on xerro-service/src/tasks/run-agent.ts
 */
export interface RunAgentProperties {
  /** The prompt/task to execute (required) */
  prompt: string;
  /** Working directory for the agent (optional) */
  cwd?: string;
  /** Permission mode: 'allow_all' or custom allow list (optional) */
  permissions?: 'allow_all' | { allowList: string[] };
  /** Additional directories the agent can access (optional) */
  additionalDirectories?: string[];
  /** Use local LLM server instead of Anthropic API (optional) */
  local?: boolean;
  /** Local LLM model name (optional, only used when local is true) */
  localModel?: string;
}

/**
 * Tool information from Claude Code
 */
export interface ToolInfo {
  name: string;
  description: string;
  category: 'filesystem' | 'execution' | 'search' | 'web' | 'ai' | 'mcp' | 'config' | 'other';
  riskLevel: 'low' | 'medium' | 'high';
}

/**
 * Category metadata
 */
export interface CategoryInfo {
  label: string;
  description: string;
}

/**
 * Response from /api/v1/scheduled-tasks/tools
 */
export interface ToolsResponse {
  tools: ToolInfo[];
  categories: Record<string, CategoryInfo>;
}

/**
 * Agent execution trace types
 */
export interface TraceToolCall {
  id: string;
  name: string;
  input: Record<string, unknown>;
  calledAt: string;
}

export interface TraceToolResult {
  toolUseId: string;
  content: string;
  isError: boolean;
  receivedAt: string;
  truncated: boolean;
  originalSizeBytes: number;
}

export interface TracePermissionRequest {
  toolUseId: string;
  toolName: string;
  decision: 'allow' | 'deny';
  reason?: string;
  timestamp: string;
}

export interface AgentExecutionTrace {
  executionId: string;
  sessionId?: string;
  model?: string;
  cwd?: string;
  permissionMode?: string;
  toolCalls: TraceToolCall[];
  toolResults: TraceToolResult[];
  permissions: TracePermissionRequest[];
  totalCostUsd?: number;
  usage?: {
    inputTokens: number;
    outputTokens: number;
    cacheCreationTokens?: number;
    cacheReadTokens?: number;
  };
}

/**
 * Running task from /api/v1/scheduled-tasks/running
 */
export interface RunningTask {
  executionId: string;
  taskId: string;
  taskName: string;
  taskType: string;
  startedAt: string;
  currentOperation: string;
  model?: string;
  isLocal: boolean;
  elapsedMs: number;
  toolName?: string;      // Current tool being used
  toolCallId?: string;    // Tool call ID
  isToolError?: boolean;  // Whether last tool result was an error
}

/**
 * Response from /api/v1/scheduled-tasks/running
 */
export interface RunningTasksResponse {
  running: RunningTask[];
}
